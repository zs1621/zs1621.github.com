
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>三余无梦</title>
  <meta name="author" content="admin">

  
  <meta name="description" content="Unicode系列目前有准备有2篇文章 介绍Unicode
Unicode在python(2.x)中的应用(让人头疼有么有) 好的下面开始 what Unicode Unicode 是一种字符集, 规定字符对应的二进制代码
平常所说的ASCII码呢，就是英语的128个字符对应的二进制代码 why &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://zs1621.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="三余无梦" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">三余无梦</a></h1>
  
    <h2>冬者岁之余，夜者日之余，阴雨者时之余也</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:zs1621.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">归档</a></li>
  <li><a href="/about">关于</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/09/unicodejie-shao-xi-lie-1/">&#8216;Unicode&#8217;介绍系列1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-09T17:10:12+08:00" pubdate data-updated="true">Aug 9<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><code>Unicode</code>系列目前有准备有2篇文章</p>

<ul>
<li>介绍Unicode</li>
<li>Unicode在python(2.x)中的应用(让人头疼有么有)</li>
</ul>


<p> 好的下面开始</p>

<h2>what Unicode</h2>

<ul>
<li>Unicode 是一种字符集, 规定字符对应的二进制代码</li>
<li>平常所说的ASCII码呢，就是英语的128个字符对应的二进制代码</li>
</ul>


<h2>why Unicode</h2>

<ul>
<li>如其名,统一编码,所有的字符都有对应的独一无二的二进制代码, 这样就能一统天下</li>
</ul>


<h2>unicode 缺陷</h2>

<ul>
<li>Unicode 规定了符号的二进制代码， 却没有规定这个二进制代码如何存储</li>
<li>如&#8217;严&#8217;的Unicode为4E25, 至少需要两个字节来表示, 就是说这个字符需要两个字节, 问题就来了,计算机不知道怎么区分2个字节表示一个符号，计算机也可以认为1个字节一个字符, 如果统一都用4字节表示每个字符，那么对于一个字节就可以表示的字符， 就是浪费,这是不能忍的</li>
<li>所以需要一种比较号好的实现模式,去解决&hellip;</li>
</ul>


<h2>UTF-8</h2>

<ul>
<li>UFT-8是在互联网上使用的最广的一种Unicode的实现方式。</li>
<li>这是一种可变长度的编码方式, 可以使用1~4个字节表示一个符号</li>
<li>编码规则:</li>
<li>对于单字节的符号, 字节的第一位设为0, 后面7位是个符号的Unicode码, 因此对于英语字母, UTF-8和ASCII码相同</li>
<li>对于n字节的符号(n > 1), 第一个字节的前n位都设位1, 第n+1位设为0, 后面字节的前两位一律设为10, 剩下的二进位,全部位这个符号的Unicode</li>
</ul>


<p>TBC</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/19/first-5-minutes-troubleshooting-server-translate/">First 5 Minutes Troubleshooting Server Translate</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-19T17:09:13+08:00" pubdate data-updated="true">Jul 19<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p><a href="http://devo.ps/blog/troubleshooting-5minutes-on-a-yet-unknown-box/">原文</a></p></blockquote>

<h2><strong>服務器遇到問題,從何下手?</strong></h2>

<p>不要急着衝向你的服務器， 在這之前， 你對它和具體的問題了解多少？</p>

<p>必須知道的</p>

<ul>
<li>問題的確切症狀? 丟包? 錯誤?</li>
<li>問題什麼時候被發現?</li>
<li>可以重現麼?</li>
<li>有什麼規律(例如每小時發生一次)?</li>
<li>在服務器的最後一次改變(代碼， 服務配置, 內存)?</li>
<li>問題會影響客戶的哪個部分(登錄， 註銷， )?</li>
<li><strong>有監控平臺麼?</strong> Munin, Zabbix, Nagios, NewRelic..</li>
<li><strong>日志(集中化)?</strong> Loggly, Airbrake, Graylog</li>
</ul>


<p>上面的最後兩項是最方便直觀的信息來源， 但也別期望太多;爲了搞定問題，繼續往下看</p>

<p><strong>誰登陸了?</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ w
</span><span class='line'>$ last</span></code></pre></td></tr></table></div></figure>


<p>不是很重要， 但是你在找問題時不希望還有其他人在擺弄的服務器。廚房裏一個廚師足矣</p>

<p><strong>之前做了哪些操作?</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ history</span></code></pre></td></tr></table></div></figure>


<p>看歷史記錄總是好的;配合之前誰在操作的命令.</p>

<p>快速回憶一下， 你也許小要升級環境變量 <code>HISTTIMEFORMAT</code> 去跟蹤那些命令運行的時刻.沒什麼比調查一個過期命令列表更讓人沮喪的了。</p>

<p><strong>正在運行哪些程序i?</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pstree -a
</span><span class='line'>$ ps aux</span></code></pre></td></tr></table></div></figure>


<p>如果覺得<code>ps aux</code>太羅嗦， <code>pstree -a</code>會給你一個漂亮的展示關於什麼正在運行以及誰調用了它</p>

<p><strong>監聽服務</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ netstat -ntlp  # t: tcp
</span><span class='line'>$ netstat -nulp  # u: udp
</span><span class='line'>$ netstat -nxlp  # x: unix socket</span></code></pre></td></tr></table></div></figure>


<p>我更傾向分開運行這些命令， 主要是因爲不喜歡同時看所有的服務。雖然<code>netstat -nalp</code>以可以做到。甚至我會省略<code>數字化</code>選項(IPs是易讀點的)</p>

<p>確定正在運行的服務以及他們是否應該運行。尋找多個監聽端口。通過<code>ps aux</code>的輸出匹配進程ID；這個是很有用的特別當你同時結束2~3個Java 或者 Erlang進程</p>

<p><strong>CPU 和 RAM</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ free -m
</span><span class='line'>$ uptime
</span><span class='line'>$ top
</span><span class='line'>$ htop</span></code></pre></td></tr></table></div></figure>


<p>這些命令回答以下問題:
 &ndash;  還有空閒的內存? 還是正在交換區 ?
 &ndash;  還有CPU剩餘麼? 服務器有多少CPU核心可用? 這些核心中是否有超載的?
 &ndash;  哪個項目負載最多? 平均負載多少?
 &ndash;  詳細了解命令<code>man</code>,你懂的</p>

<p><strong>Hardware</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ lspci
</span><span class='line'>$ dmidecode
</span><span class='line'>$ ethtool</span></code></pre></td></tr></table></div></figure>


<p>TODO: explain commands</p>

<p><strong>IO 性能</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ iostat -kx 2
</span><span class='line'>$ vmstat 2 10
</span><span class='line'>$ mpstat 2 10
</span><span class='line'>$ dstat --top-io --top-bio</span></code></pre></td></tr></table></div></figure>


<p>這幾個是非常有用的命令去分析後臺性能;</p>

<ul>
<li>check 硬盤使用:</li>
<li>交換區目前有沒有使用</li>
<li>什麼程序再使用CPU: 系統? 用戶? stolen ?</li>
<li><code>dstat</code> 一直是我的最愛. IO消耗? mysql 阻塞資源? php進程在使用的你io&hellip;</li>
</ul>


<p><strong>掛載點和文件系統</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mount
</span><span class='line'>$ cat /etc/fstab
</span><span class='line'>$ vgs
</span><span class='line'>$ pvs
</span><span class='line'>$ lvs
</span><span class='line'>$ df -h
</span><span class='line'>$ lsof +D / /* </span></code></pre></td></tr></table></div></figure>


<ul>
<li>多少文件系統被掛載</li>
<li>過期的文件系統</li>
<li>硬盤空間是否有剩餘</li>
<li>大文件還沒有清除</li>
<li>如果硬盤有問題還有空間去加個分區?</li>
</ul>


<p> <strong>內核,中斷, 網絡使用情況</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sysctl -a | grep ...
</span><span class='line'>$ cat /proc/interrupts
</span><span class='line'>$ cat /proc/net/ip_conntrack
</span><span class='line'>$ netstat
</span><span class='line'>$ ss -s</span></code></pre></td></tr></table></div></figure>


<p>TBC</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/14/expressjs-slash-finished-code-reading/">Expressjs/finished Code Reading</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-14T11:57:26+08:00" pubdate data-updated="true">Jul 14<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>* <a href="https://github.com/expressjs/finished">finished</a></h2>

<ul>
<li>功能: 在请求关闭，完成， 或者出错时执行回调</li>
<li>用例: 清除传输流。例如为了防止文件描述符泄漏，在socket出错时， 你会想要将文件流摧毁</li>
</ul>


<h2><strong>从一个koa例子开始</strong></h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var onFinished = require('finished');
</span><span class='line'>function* () {
</span><span class='line'>    var stream = this.body = fs.createReadStream('thingie.json');   
</span><span class='line'>    onFinished(this, function(err) {
</span><span class='line'>        stream.destroy();    
</span><span class='line'>    })
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>再看finished的代码</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>module.exports = function finished (thingie, callback) {
</span><span class='line'>    /*
</span><span class='line'>     * 主要需要監測socket和res的事件 
</span><span class='line'>     */
</span><span class='line'>    var socket = thingie.socket || thingie;    
</span><span class='line'>    var res = thingie.res || thingie; 
</span><span class='line'>
</span><span class='line'>    /*
</span><span class='line'>     * res完成或者socket不可寫的時候， 直接執行callback, 返回thingie
</span><span class='line'>     */
</span><span class='line'>    if ( res.finished || !socket.writable) {
</span><span class='line'>        defer(callback);    
</span><span class='line'>        return thingie;
</span><span class='line'>    };  
</span><span class='line'>
</span><span class='line'>    /*
</span><span class='line'>     * 第一次運行時listener 和 res.__onFinished 是不存在的
</span><span class='line'>     */
</span><span class='line'>    var listener = res.__onFinished;
</span><span class='line'>
</span><span class='line'>    if (!listener || !listener.queue) {
</span><span class='line'>        listener = res.__onFinished = function onFinished(err)  {
</span><span class='line'>            if (res.__onFinished === listener) res.__onFinished = null; // 這句表明每次給listener 賦完值， res.__onFinished = null;
</span><span class='line'>            var queue = listener.queue || [];
</span><span class='line'>            while (queue.length) queue.shift()(err)
</span><span class='line'>        }   
</span><span class='line'>        listerner.queue = [];
</span><span class='line'>
</span><span class='line'>        first([
</span><span class='line'>            [socket, 'error', 'close'], 
</span><span class='line'>            [res, 'finish'],
</span><span class='line'>        ], listener); // 看[first](https://github.com/jonathanong/ee-first)模块解析: 主要功能在监听到指定的事件的第一件时，触发响应回调， 并清除移除所有的监听。
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    listener.queue.push(callback);
</span><span class='line'>
</span><span class='line'>    return thingie;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2><em>想要具体看finish的应用场景，其实在<a href="https://github.com/expressjs/finished/blob/master/test/test.js">单元测试</a>里有很多具体的例子</em></h2>

<ul>
<li>下面具体理解下其中的一个单元测试</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> describe('when the request finished', function () {
</span><span class='line'>    it('should execute the callback when called after finish', function(done){
</span><span class='line'>        var server = http.createServer(function(req, res){
</span><span class='line'>            onFinished(res, function(){
</span><span class='line'>                //第4步
</span><span class='line'>                onFinished(res, done); // 第5步   
</span><span class='line'>            }) // 第2步   
</span><span class='line'>            setTimeout(res.end.bind(res), 0); // 第3步
</span><span class='line'>        })  // 第 0 步  
</span><span class='line'>        server.listen(function(){
</span><span class='line'>            var port = this.address().port;    
</span><span class='line'>            http.get('http://127.0.0.1:' + port, function(){
</span><span class='line'>                res.resume();
</span><span class='line'>                res.on('close', server.close.bind(server));
</span><span class='line'>            }) //第1步
</span><span class='line'>        })
</span><span class='line'>    })    
</span><span class='line'> })</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>测试步骤</strong></li>
<li>先创建服务器 第0步</li>
<li>监听端口,做出请求 第一步</li>
<li>服务器收到请求， 执行回调函数 <code>onFinished(res, function(){})</code> 第2步</li>
<li>第3步的话  结束请求 res.end.bind(res)</li>
<li>第4步  监听到结束, 执行回调 <code>onFinished(res, done)</code></li>
<li><p>第5步  完成done</p></li>
<li><p><strong>测试结论</strong>:当服务器完成请求后，有onFinished()的话， 直接执行回调, 然后结束</p></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/04/wwdc14/">WWDC14</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-04T00:26:00+08:00" pubdate data-updated="true">Jun 4<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>WWDC14 观后感</h2>

<p>WWDC苹果全球开发者大会.
 看完10小时，列下我能记住的几点</p>

<ul>
<li>mac 在手机在旁边的情况下，可以拨接电话，收发短信</li>
<li>spotlight 可以联网搜索</li>
<li>touchId 指纹解锁</li>
<li>instant hotspot: mac 和 iphone ipad 即时同步</li>
<li>swift 语言，新的apple开发语言</li>
<li>heathKit 监测健康信息，包括心率、胆固醇等</li>
</ul>


<h3>mac打电话</h3>

<ul>
<li>just cool, convenient</li>
</ul>


<h3>spotlight</h3>

<ul>
<li>Alfred堪忧了，从接触的朋友来看， 接触MAC OS的比Windows的用此功能的多。可能windows中本地搜素太慢了吧,其实联网搜索聚合windows8就有了，但是&hellip;</li>
</ul>


<h3>TouchId</h3>

<ul>
<li>还是方便快捷， 从一个侧面反映未来的互联网安全是更加被看重了,因为一个账号，可以牵一发而动全身。可以预见安全研究员之类的工作会越来越多。</li>
</ul>


<h3>instant hotspot</h3>

<ul>
<li>体验不间断</li>
</ul>


<h3>swift</h3>

<ul>
<li>新的即视编程语言， 语言的发展就是向着更方便，更快。更方便就是对于程序员更好上手， 更快是对于编译器的要求， 从事编译器工作的同学要求会更高， 对于普通程序员在我看来是应用创意的提高!</li>
</ul>


<h3>HeathKit &amp;&amp; HomeKit</h3>

<ul>
<li>heathKit 是我觉得最牛的东西了， 直接体现apple的态度， 专做软件和服务， 与硬件厂商合作， 与第三方开发者合作， 提供接口， 连接各种硬件。但是Iphone 始终是<strong>中枢系统</strong>。 heathKit重点是健康类的监控， 这与医药公司合作， 对于病人的各方面数据监控， 而改善人们的生活&hellip;.(PS:未来越来越多的硬件厂商会与移动网络连接，而中间的通信安全会有越来越多的人在关注)</li>
</ul>


<h3>企业市场</h3>

<ul>
<li>大会中提到500强企业中498家都在用苹果的设备。个人觉得苹果会慢慢渗入企业，包括其软件服务，not only <strong>大众消费品</strong>。</li>
</ul>


<blockquote><p>(PS： 此文是用<a href="http://maxiang.info/">马克飞象</a> 挺好用的~~)</p></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/28/koa-compose-code-reading/">Koa-compose Code Reading</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-28T10:37:00+08:00" pubdate data-updated="true">May 28<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2><strong><a href="https://github.com/koajs/compose/blob/master/index.js">compose</a></strong></h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function compose(middleware) {
</span><span class='line'>   return function *(next) {
</span><span class='line'>        var i = middleware.length;   
</span><span class='line'>        var prev = next || noop ();
</span><span class='line'>        var curr;
</span><span class='line'>        
</span><span class='line'>        while (i--) {
</span><span class='line'>            curr = middleware[1];    
</span><span class='line'>            prev = curr.call(this, prev); // 
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        yield *prev;
</span><span class='line'>   } 
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>看下例的运行效果</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var co = require('co');
</span><span class='line'>
</span><span class='line'>var stack = [];
</span><span class='line'>var arr = [];
</span><span class='line'>stack.push(function *(next) {
</span><span class='line'>    arr.push(1);    
</span><span class='line'>    yield next;
</span><span class='line'>    arr.push(3);
</span><span class='line'>});
</span><span class='line'>stack.push(function *(next){
</span><span class='line'>    arr.push(2);    
</span><span class='line'>    yield next;
</span><span class='line'>    arr.push(4)
</span><span class='line'>});
</span><span class='line'>
</span><span class='line'>co(compose(stack)) (function (err) {
</span><span class='line'>    if (err) throw err;   
</span><span class='line'>    console.log(arr); // 输出 [1, 2, 3, 4], 从输出可以看到其执行顺序
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p>从上例的程序可以看到<a href="https://github.com/koajs/koa/blob/master/lib/application.js#L113">koa</a>。koa在加载中间件时是通过co 和 compose来按次序拨开一层一层的middleware。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>co (function *() {
</span><span class='line'>    var arr = []
</span><span class='line'>    var funa = function *(next) {
</span><span class='line'>        arr.push(1);    
</span><span class='line'>        yield *next;
</span><span class='line'>        arr.push(3);
</span><span class='line'>    };
</span><span class='line'>    var funb = function *(next) {
</span><span class='line'>        arr.push(2);
</span><span class='line'>        yield *next;
</span><span class='line'>        arr.push(4)
</span><span class='line'>    };
</span><span class='line'>    funa ();
</span><span class='line'>    funb ();
</span><span class='line'>    return arr;
</span><span class='line'>})(function (err, items) {
</span><span class='line'> if (err) {
</span><span class='line'>    console.log(err);     
</span><span class='line'> }
</span><span class='line'> console.log(items);    
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/21/node-thunkify-code-reading/">Node-thunkify Code Reading</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-21T12:02:00+08:00" pubdate data-updated="true">May 21<span>st</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2><a href="https://github.com/visionmedia/node-thunkify">thunkify</a></h2>

<h2>code</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function thunkify(fn) {
</span><span class='line'>    assert('function' == typeof fn, 'function required');    
</span><span class='line'>
</span><span class='line'>    return function () {
</span><span class='line'>        var args = slice.call(arguments);    
</span><span class='line'>        var ctx = this;
</span><span class='line'>        return function (done) {   // done 是回调函数
</span><span class='line'>            var called;
</span><span class='line'>            args.push(function() {
</span><span class='line'>                if (called) return;
</span><span class='line'>                called = true;    
</span><span class='line'>                done.apply(null, arguments); 
</span><span class='line'>            }); // 将回调处理加入参数列表
</span><span class='line'>
</span><span class='line'>            try {
</span><span class='line'>                fn.apply(ctx, args);   // 函数处理 
</span><span class='line'>            } catch (err) {
</span><span class='line'>                done(err);   // 异常获取并用回调处理 
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<h2>例子</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var thunkify = require('thunkify');
</span><span class='line'>var fs = require('fs');
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>var read = thunkify(fs.readFile);
</span><span class='line'>
</span><span class='line'>read('package.json', 'utf8')(function(err, str){
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/17/koa-dot-js-code-reading/">Koa.js Code Reading</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-17T15:23:00+08:00" pubdate data-updated="true">Jan 17<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>TBC 继续挖坑待填&hellip;</p>

<h2><a href="https://github.com/koajs/koa">Koa</a></h2>

<p>源码简况</p>

<ul>
<li>version： 0.8.2</li>
<li>用到的库

<ul>
<li>escape-html: =1.0.1</li>
<li>statuses: =1.0.1</li>
<li>accepts: 1.0.0</li>
<li>type-is: 1.1.0</li>
<li>set-type: 1.0.0</li>
<li>mime-types: 1.0.0</li>
<li><a href="https://zs1621.github.io/blog/2014/07/14/expressjs-slash-finished-code-reading/">finished: 1.2.0</a></li>
<li>co: 3.0.2</li>
<li>debug</li>
<li>fresh: 0.2.1</li>
<li><a href="https://zs1621.github.io/blog/2014/05/28/koa-compose-code-reading/">koa-compose: 2.2.0</a></li>
<li>koa-is-json: 1.0.0</li>
<li>cookies: 0.4.0</li>
<li>delegates: 0.0.3</li>
<li><a href="https://github.com/visionmedia/node-delegates/blob/master/index.js">delegates</a>: 0.0.3 -已读 -13/5</li>
<li>dethroy: 1.0.0</li>
<li>vary: 0.1.0</li>
<li>error-inject: 1.0.0</li>
<li>parseurl: 1.2.0</li>
<li><a href="https://github.com/visionmedia/node-only">only</a>: 0.0.2  -已读 -9/5</li>
</ul>
</li>
<li>运行条件: node 版本大于0.11.9</li>
</ul>


<h2><strong>从入口说起</strong></h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var koa = require('koa');
</span><span class='line'>var app = koa();
</span><span class='line'>
</span><span class='line'>app.use(function *(){
</span><span class='line'>    this.body = 'Hello World';    
</span><span class='line'>});
</span><span class='line'>
</span><span class='line'>app.listen(3000);</span></code></pre></td></tr></table></div></figure>


<p>上面是一个最简单的服务,输出<code>Hello World</code>; 我们用到两个koa的api</p>

<ul>
<li>app.use()</li>
<li>app.listen();</li>
</ul>


<p>下面就先从app.listen() 开始</p>

<p>看 <a href="https://github.com/koajs/koa/blob/master/lib/application.js">application.js</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app.listen = function () {
</span><span class='line'>    var server = http.createServer(this.callback()) ;  
</span><span class='line'>    return server.listen.apply(server, arguments);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<blockquote><p>http.createServer([requestListener])
 returns a new web server object</p>

<p><code>requestListener</code> is a function which is automatically added to the <code>'request'</code> 事件</p></blockquote>

<p>由代码可以知道 this.callback() 就是一个 <code>requestListener</code>;</p>

<p>来到<code>app.callback</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app.callback = function () {
</span><span class='line'>    var mw = [respond].concat(this.middleware);   // 实际上 respond 就是最后一个需要执行的中间件， 负责返回数据的 
</span><span class='line'>    var gen = compose(mw); 
</span><span class='line'>    var fn = co(gen);  // co 和 compose 就是将一个个middle，按序执行的操作, 此时middle还没有运行
</span><span class='line'>    var self = this;
</span><span class='line'>    
</span><span class='line'>    if (!this.listeners('error').length) this.on('error', this.onerror);
</span><span class='line'>    
</span><span class='line'>    return function (req, res) {
</span><span class='line'>        res.statusCode = 404;    
</span><span class='line'>        var ctx = self.createContext(req, res);
</span><span class='line'>        finished(ctx, ctx.onerror);
</span><span class='line'>        fn.call(ctx, ctx.onerror); // 这步运行了说明服务器接收到了请求， 然后一步步的运行middle 和 请求业务处理
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>上面的代码基本上就解释了整个请求到回复的流程</p>

<p>下面分解开来</p>

<ul>
<li><code>createContext(req, res)</code></li>
<li><code>finished(ctx, ctx.onerror)</code></li>
<li><code>fn.call(ctx, ctx.onerror)</code></li>
</ul>


<p>TBC</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/27/underscore-dot-js-code-reading/">underscore.js Code Reading</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-27T21:14:00+08:00" pubdate data-updated="true">Dec 27<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3><a href="https://github.com/jashkenas/underscore/blob/master/underscore.js">underscore</a></h3>

<p>挖坑待续</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/18/lazy-dot-js-code-reading/">Lazy.js Code Reading</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-18T08:58:00+08:00" pubdate data-updated="true">Dec 18<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3><a href="https://github.com/dtao/lazy.js">Lazy.js</a></h3>

<p>在看源码前， 可以先看下Lazy.js的基本思想 <a href="https://github.com/zs1621/lazy.js/wiki/%E4%BB%8B%E7%BB%8D-LAZYJS(%E7%BF%BB%E8%AF%91">Lazy.js 的设计模式</a>)</p>

<h3>Lazy</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Lazy</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span> <span class="c1">// in [1, 2, 4] -&gt; out instanceof Lazy.ArrayLikeSequence </span>
</span><span class='line'><span class="nx">Lazy</span><span class="p">({</span> <span class="nx">a</span><span class="o">:</span> <span class="s1">&#39;b&#39;</span><span class="p">})</span>
</span><span class='line'><span class="nx">Lazy</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nx">Lazy</span><span class="p">()</span>
</span><span class='line'><span class="nx">Lazy</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>输入参数 Array | object | string |  | null</li>
<li>输出 { source: [1, 2, 4] } | { source: {&lsquo;a&rsquo;: b} } | { source: &ldquo;hello world&rdquo;} | { source: undefined }  | { source: null }</li>
<li>可以看到输入的参数被打包成相应的对象, 而这些对象都继承自 <code>sequence</code></li>
</ul>


<h3>Sequence</h3>

<p><code>sequence</code> 对象提供对 0或者更多连续元素的集合 的统一的 API 封装.为什么所有的操作需要一个 sequence. 看下面的例子</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">seq</span> <span class="o">=</span> <span class="nx">Lazy</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="c1">// 1st sequence</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="c1">// 2nd MappedSequence</span>
</span><span class='line'>       <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">pred</span><span class="p">)</span> <span class="c1">// 3rd FilteredSequence</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">reverse</span><span class="p">()</span> <span class="c1">// 4th ReversedSequence</span>
</span><span class='line'><span class="nx">seq</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span> <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面这个例子中 前四步除了创建对应的sequece没有做任何的遍历source或者别的操作。 只有在第5步调用 each 时，将一次性按照鍊條(chain)的順序处理source 得到最后的结果。所以lazy做的就是延迟遍历处理数据.</p>

<blockquote><p>in fact, when i think about  the performance of <code>underscore</code> and <code>lazy.js</code>; i cann&rsquo;t understand why lazy is faster.  lazy.js: 1 2s 3 underscore: 1 2 3 1 2 3 1 2 3 . so what&rsquo;s the difference. lazy.js just hold off some process; i cann&rsquo;t get it&hellip;. so continue to read code. >_&lt;</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">Sequence</span><span class="p">()</span> <span class="p">{}</span> <span class="err">#</span> <span class="err">创建</span><span class="nx">Sequence</span><span class="err">构造函数</span>
</span></code></pre></td></tr></table></div></figure>


<p>TBC</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/07/generic-pool-reading/">Generic-pool Reading</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-07T02:00:00+08:00" pubdate data-updated="true">Dec 7<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2><a href="https://github.com/coopernurse/node-pool">node-pool</a></h2>

<h3>why pool</h3>

<ul>
<li>与数据建立连接关闭连接， 每次建立一个连接对象会有消耗!(在并发很高的情况消耗会更明显)</li>
</ul>


<h3>what node-pool can do ?</h3>

<ul>
<li>动态调整连接数的连接池, 数据库频繁读写时, 就建多个连接, 当然连接数有最大值Max, 如果读写实际需要的连接数 > Max 那么加入队列里;如果数据库读写空闲，就释放多余的连接;</li>
</ul>


<h3>how node-pool do that ? &ndash;> Code Reading</h3>

<ul>
<li>栗子</li>
</ul>


<script src="https://gist.github.com/zs1621/7836578.js"></script>


<p>运行上面的例子</p>

<ol>
<li>新建一个pool对象, 初始化一些变量

<ul>
<li>idleTimeoutMillis: 一个连接空闲时间最大值, 如果设置为30000, 那么一个连接空闲30000ms 后会自动关闭, 默认 30000ms</li>
<li>reapIntervalMillis:  每<code>reapIntervalMillis</code>检查空闲并移除, 默认1000ms</li>
<li>max: 连接池存在的最大连接数, 例子里设置为10</li>
<li>min: 连接池存在的最小连接数, 例子里默认为0(备注: 这里有个疑问，当我将min设为1, 从mongodb log 中可以看到 在空闲时间 连接是每隔<code>idleTimeoutMillis</code>关闭并新建连接, 问题是为什么不保持一个连接而要不停的关闭新建, 如果这样不如)</li>
<li>log: 可以自定义node-pool, 例子直接设为true 默认用node-pool提供的log</li>
<li>create: 应该创建一个item(db) 被 <code>acquired</code>, 然后调用其创建的 item 作为参数</li>
<li>destory: 在items毁之前,关闭所有资源使用的item(db)</li>
</ul>
</li>
<li>ensureMinimum, 确保有最小连接数</li>
<li> 例子中如果给min赋一个大于0的值, 2, 那么就 createResource()两次</li>
<li> 因为例子默认为0 跳过</li>
<li>至此已经建立pool, 下一步等待<code>acquired</code>, 资源准备就续, 就等消费了</li>
<li><code>curl http://127.0.0.1:8080</code></li>
<li><code>acquire(callback, priority)</code>

<ul>
<li>waitingClients.enqueue(callback, priority): 将回调根据priority推入队列</li>
<li>dispense(): 由单词意思可知分配资源， 施行; 试着拿一个客户端工作， 清除空闲的item. 如果有等待的client, shift(), call its callback. 如果没有等待的client, 创建一个; 如果创建一个client将超过max, 把客户端加入等待list!代码见 <a href="#dispense">dispense</a></li>
</ul>
</li>
<li> dispense() 结束,此时 waitingClients.size() = 0, availableObjects.length = 0</li>
<li>release(): 如果client不再需要，将之返回pool, 代码见<a href="#release">release</a></li>
<li><p>removeIdle(): check and removes the available clients that have timed out. 见<a href="#removeIdle">removeIdle</a></p></li>
<li><p>me.destroy(): client to be destroyed.见<a href="#destroy">destroy</a></p></li>
</ol>


<p><a name="dispense" id="despense"><strong>dispense</strong></a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">dispense</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">objWithTimeout</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">err</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">clientCb</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">waitingCount</span> <span class="o">=</span> <span class="nx">waitingClients</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">waitingCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//此时waitingCount = 1</span>
</span><span class='line'>        <span class="k">while</span><span class="p">(</span><span class="nx">availableObjects</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">log</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">objWithTimeout</span> <span class="o">=</span> <span class="nx">avaiableObjects</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">factory</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span><span class="nx">objWithTimeout</span><span class="p">.</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">me</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="nx">objWithTimeout</span><span class="p">.</span><span class="nx">obj</span><span class="p">);</span>
</span><span class='line'>                <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span> <span class="c1">// 这一步验证对象</span>
</span><span class='line'>            <span class="nx">avaiableObjects</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="c1">// LIFO</span>
</span><span class='line'>            <span class="nx">clientCb</span> <span class="o">=</span> <span class="nx">waitingClients</span><span class="p">.</span><span class="nx">dequeue</span><span class="p">();</span> <span class="c1">// dequeue</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">clientCb</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">objWithTimeout</span><span class="p">.</span><span class="nx">obj</span><span class="p">);</span> <span class="c1">// callback</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">&lt;</span> <span class="nx">factory</span><span class="p">.</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">createResource</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="release" id="release"><strong>release</strong></a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">me</span><span class="p">.</span><span class="nx">release</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 确保对象已经被释放</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">availableObjects</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">objWithTimeout</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="nx">objWithTimeout</span><span class="p">.</span><span class="nx">obj</span> <span class="o">===</span> <span class="nx">obj</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}))</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">log</span><span class="p">(</span><span class="s2">&quot;release called twice for the same resource&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">objWithTimeout</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">obj</span><span class="o">:</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">timeout</span><span class="o">:</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="nx">idleTimeoutMillis</span><span class="p">)</span> <span class="p">};</span>
</span><span class='line'>    <span class="nx">availableObjects</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">objWithTimeout</span><span class="p">);</span> <span class="c1">// 此时 availableObjects.size()=1</span>
</span><span class='line'>    <span class="nx">log</span><span class="p">(</span><span class="s2">&quot;timeout:..&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">dispense</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">scheduleRemoveIdle</span><span class="p">();</span> <span class="c1">// 计划移走idle items(空闲项目) 延迟1000ms 执行 removeIdle</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="removeIdle" id="removeIdle"><strong>removeIdle</strong></a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'> <span class="kd">function</span> <span class="nx">removeIdle</span><span class="p">(){</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">toRemove</span> <span class="o">=</span> <span class="p">[],</span>
</span><span class='line'>        <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">(),</span>
</span><span class='line'>        <span class="nx">i</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">al</span><span class="p">,</span> <span class="nx">tr</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">timeout</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">removeIdleScheduled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// go through the available(idle) items, check if they have timed out;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">al</span><span class="o">=</span><span class="nx">availableObjects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span> <span class="nx">al</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>        <span class="p">(</span><span class="nx">refreshIdle</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">count</span> <span class="o">-</span> <span class="nx">factory</span><span class="p">.</span><span class="nx">min</span> <span class="o">&gt;</span> <span class="nx">toRemove</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span><span class="nx">i</span><span class="o">+=</span><span class="mi">1</span>
</span><span class='line'>        <span class="p">){</span>
</span><span class='line'>        <span class="nx">timeout</span> <span class="o">=</span> <span class="nx">availableObjects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">timeout</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">now</span> <span class="o">&gt;=</span> <span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>           <span class="c1">//client timed out, so destroy it </span>
</span><span class='line'>           <span class="nx">toRemove</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">availableObjects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">obj</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">tr</span><span class="o">=</span><span class="nx">toRemove</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">tr</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">me</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="nx">toRemove</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nx">al</span> <span class="o">=</span> <span class="nx">availableObjects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">al</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>           <span class="nx">log</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">);</span>
</span><span class='line'>           <span class="nx">scheduleRemoveIdle</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">log</span><span class="p">(</span><span class="s2">&quot;removeIdle() all objects removed&quot;</span><span class="p">,</span> <span class="s1">&#39;verbose&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>     <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="destroy" id="destroy"><strong>destroy</strong></a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'> <span class="nx">me</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">count</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">availableOjbects</span> <span class="o">=</span> <span class="nx">availableObjects</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">objWithTimeout</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="k">return</span> <span class="p">(</span><span class="nx">objWithTimeout</span><span class="p">.</span><span class="nx">obj</span> <span class="o">!=</span> <span class="nx">obj</span><span class="p">)</span>
</span><span class='line'>        <span class="p">});</span><span class="c1">//过滤掉return true 的对象</span>
</span><span class='line'>    <span class="nx">factory</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">ensureMinimum</span><span class="p">();</span>
</span><span class='line'>     <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/08/09/unicodejie-shao-xi-lie-1/">&#8216;Unicode&#8217;介绍系列1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/19/first-5-minutes-troubleshooting-server-translate/">First 5 Minutes Troubleshooting Server Translate</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/14/expressjs-slash-finished-code-reading/">Expressjs/finished Code Reading</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/04/wwdc14/">WWDC14</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/28/koa-compose-code-reading/">Koa-compose Code Reading</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - admin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
